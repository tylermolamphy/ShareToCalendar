name: Build & Release

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

permissions:
  contents: write
  pull-requests: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Cache Gradle packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Run unit tests
        run: ./gradlew test

      - name: Build debug APK
        run: ./gradlew assembleDebug

      - name: Get APK size
        id: apk
        run: |
          APK_PATH="app/build/outputs/apk/debug/app-debug.apk"
          APK_SIZE=$(du -h "$APK_PATH" | cut -f1)
          echo "size=${APK_SIZE}" >> "$GITHUB_OUTPUT"

      - name: Get test results
        if: always()
        id: tests
        run: |
          TOTAL=0
          FAILED=0
          for f in app/build/test-results/*/TEST-*.xml; do
            if [ -f "$f" ]; then
              T=$(grep -oP 'tests="\K[0-9]+' "$f" | head -1)
              F=$(grep -oP 'failures="\K[0-9]+' "$f" | head -1)
              E=$(grep -oP 'errors="\K[0-9]+' "$f" | head -1)
              TOTAL=$((TOTAL + T))
              FAILED=$((FAILED + F + E))
            fi
          done
          PASSED=$((TOTAL - FAILED))
          echo "total=${TOTAL}" >> "$GITHUB_OUTPUT"
          echo "passed=${PASSED}" >> "$GITHUB_OUTPUT"
          echo "failed=${FAILED}" >> "$GITHUB_OUTPUT"

      - name: Comment on PR
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const status = '${{ job.status }}';
            const emoji = status === 'success' ? 'âœ…' : 'âŒ';
            const total = '${{ steps.tests.outputs.total }}';
            const passed = '${{ steps.tests.outputs.passed }}';
            const failed = '${{ steps.tests.outputs.failed }}';
            const apkSize = '${{ steps.apk.outputs.size }}' || 'N/A';
            const sha = context.sha.substring(0, 7);

            let body = `## ${emoji} Build ${status}\n\n`;
            body += `| Metric | Result |\n|--------|--------|\n`;
            body += `| **Tests** | ${passed}/${total} passed`;
            if (failed > 0) body += ` (${failed} failed)`;
            body += ` |\n`;
            if (status === 'success') {
              body += `| **APK Size** | ${apkSize} |\n`;
            }
            body += `| **Commit** | \`${sha}\` |\n`;
            body += `\n<sub>ðŸ¤– Generated by GitHub Actions</sub>`;

            // Find and update existing comment, or create new one
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            const botComment = comments.find(c =>
              c.user.type === 'Bot' && c.body.includes('Generated by GitHub Actions')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body,
              });
            }

      - name: Generate version tag
        if: github.event_name == 'push'
        id: version
        run: |
          VERSION=$(grep 'versionName' app/build.gradle.kts | head -1 | sed 's/.*"\(.*\)".*/\1/')
          BUILD_NUM=${{ github.run_number }}
          TAG="v${VERSION}-build.${BUILD_NUM}"
          echo "tag=${TAG}" >> "$GITHUB_OUTPUT"
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"

      - name: Create GitHub Release
        if: github.event_name == 'push'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: "Build ${{ steps.version.outputs.tag }}"
          body: |
            Automated build from commit ${{ github.sha }}
            Branch: ${{ github.ref_name }}
          files: app/build/outputs/apk/debug/app-debug.apk
          generate_release_notes: true
