name: Build & Release

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

permissions:
  contents: write
  pull-requests: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Cache Gradle packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Run unit tests
        run: ./gradlew test

      - name: Build debug APK
        run: ./gradlew assembleDebug

      - name: Get APK size
        id: apk
        run: |
          APK_PATH="app/build/outputs/apk/debug/app-debug.apk"
          APK_SIZE=$(du -h "$APK_PATH" | cut -f1)
          echo "size=${APK_SIZE}" >> "$GITHUB_OUTPUT"

      - name: Get test results
        if: always()
        id: tests
        run: |
          TOTAL=0
          FAILED=0
          for f in app/build/test-results/*/TEST-*.xml; do
            if [ -f "$f" ]; then
              T=$(grep -oP 'tests="\K[0-9]+' "$f" | head -1)
              F=$(grep -oP 'failures="\K[0-9]+' "$f" | head -1)
              E=$(grep -oP 'errors="\K[0-9]+' "$f" | head -1)
              TOTAL=$((TOTAL + T))
              FAILED=$((FAILED + F + E))
            fi
          done
          PASSED=$((TOTAL - FAILED))
          echo "total=${TOTAL}" >> "$GITHUB_OUTPUT"
          echo "passed=${PASSED}" >> "$GITHUB_OUTPUT"
          echo "failed=${FAILED}" >> "$GITHUB_OUTPUT"

      - name: Upload debug APK
        if: success()
        id: upload-apk
        uses: actions/upload-artifact@v4
        with:
          name: debug-apk
          path: app/build/outputs/apk/debug/app-debug.apk
          retention-days: 14

      - name: Comment on PR (build results)
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const status = '${{ job.status }}';
            const emoji = status === 'success' ? '‚úÖ' : '‚ùå';
            const total = '${{ steps.tests.outputs.total }}';
            const passed = '${{ steps.tests.outputs.passed }}';
            const failed = '${{ steps.tests.outputs.failed }}';
            const apkSize = '${{ steps.apk.outputs.size }}' || 'N/A';
            const sha = context.sha.substring(0, 7);
            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            const artifactUrl = `${runUrl}/artifacts`;

            let body = `## ${emoji} Build ${status}\n\n`;
            body += `| Metric | Result |\n|--------|--------|\n`;
            body += `| **Unit Tests** | ${passed}/${total} passed`;
            if (failed > 0) body += ` (${failed} failed)`;
            body += ` |\n`;
            if (status === 'success') {
              body += `| **APK Size** | ${apkSize} |\n`;
              body += `| **APK Download** | [debug-apk](${artifactUrl}) |\n`;
            }
            body += `| **Commit** | \`${sha}\` |\n`;
            body += `\n> ‚è≥ Emulator tests & screenshot pending‚Ä¶\n`;
            body += `\n<sub>ü§ñ Generated by GitHub Actions</sub>`;

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            const botComment = comments.find(c =>
              c.user.type === 'Bot' && c.body.includes('Generated by GitHub Actions')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body,
              });
            }

      - name: Generate version tag
        if: github.event_name == 'push'
        id: version
        run: |
          VERSION=$(grep 'versionName' app/build.gradle.kts | head -1 | sed 's/.*"\(.*\)".*/\1/')
          BUILD_NUM=${{ github.run_number }}
          TAG="v${VERSION}-build.${BUILD_NUM}"
          echo "tag=${TAG}" >> "$GITHUB_OUTPUT"
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"

      - name: Create GitHub Release
        if: github.event_name == 'push'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: "Build ${{ steps.version.outputs.tag }}"
          body: |
            Automated build from commit ${{ github.sha }}
            Branch: ${{ github.ref_name }}
          files: app/build/outputs/apk/debug/app-debug.apk
          generate_release_notes: true

  emulator:
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'pull_request'
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Cache Gradle packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Enable KVM
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm

      - name: Run emulator tests & capture screenshot
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 31
          arch: x86_64
          target: google_apis
          force-avd-creation: false
          emulator-options: -no-snapshot-save -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim
          disable-animations: true
          script: |
            # Wait for emulator to be fully booted
            adb wait-for-device shell 'while [[ -z $(getprop sys.boot_completed) ]]; do sleep 1; done;'

            # Run instrumented tests in two separate invocations.
            # MainActivityTest must run FIRST (without permissions) because revoking
            # dangerous permissions on API 31+ kills the app process, making in-process
            # revocation impossible. DefaultCalendarTest uses GrantPermissionRule which
            # persists for the rest of the process lifetime.
            ./gradlew connectedDebugAndroidTest -Pandroid.testInstrumentationRunnerArguments.class=com.tylermolamphy.sharetocalendar.MainActivityTest || true

            # Preserve first run's test results before second invocation cleans output dir
            mkdir -p /tmp/test-results
            cp app/build/outputs/androidTest-results/connected/*/TEST-*.xml /tmp/test-results/ 2>/dev/null || true

            ./gradlew connectedDebugAndroidTest -Pandroid.testInstrumentationRunnerArguments.class=com.tylermolamphy.sharetocalendar.DefaultCalendarTest || true

            # Merge first run's results back into the output directory
            RESULTS_DIR="$(ls -d app/build/outputs/androidTest-results/connected/*/ 2>/dev/null | head -1)"
            if [ -n "$RESULTS_DIR" ]; then cp /tmp/test-results/TEST-*.xml "$RESULTS_DIR" 2>/dev/null || true; fi

            # connectedDebugAndroidTest uninstalls the APK after running, so reinstall it
            ./gradlew installDebug

            # Wake screen and dismiss keyguard
            adb shell input keyevent KEYCODE_WAKEUP
            adb shell wm dismiss-keyguard

            # Grant calendar permissions so the app shows calendar list (not the permission prompt)
            adb shell pm grant com.tylermolamphy.sharetocalendar android.permission.READ_CALENDAR
            adb shell pm grant com.tylermolamphy.sharetocalendar android.permission.WRITE_CALENDAR

            # Launch the app
            adb shell am start -W -n com.tylermolamphy.sharetocalendar/.MainActivity

            # Wait for the app to render, then verify activity is in foreground
            sleep 3
            for i in 1 2 3 4 5; do adb shell dumpsys activity activities | grep -q 'mResumedActivity.*sharetocalendar' && break || sleep 2; done

            # Take a screenshot
            adb exec-out screencap -p > screenshot.png

      - name: Get instrumented test results
        if: always()
        id: ui-tests
        run: |
          TOTAL=0
          FAILED=0
          for f in app/build/outputs/androidTest-results/connected/*/TEST-*.xml; do
            if [ -f "$f" ]; then
              T=$(grep -oP 'tests="\K[0-9]+' "$f" | head -1)
              F=$(grep -oP 'failures="\K[0-9]+' "$f" | head -1)
              E=$(grep -oP 'errors="\K[0-9]+' "$f" | head -1)
              TOTAL=$((TOTAL + T))
              FAILED=$((FAILED + F + E))
            fi
          done
          PASSED=$((TOTAL - FAILED))
          echo "total=${TOTAL}" >> "$GITHUB_OUTPUT"
          echo "passed=${PASSED}" >> "$GITHUB_OUTPUT"
          echo "failed=${FAILED}" >> "$GITHUB_OUTPUT"
          if [ "$TOTAL" -eq 0 ]; then
            echo "status=‚ö†Ô∏è No tests found" >> "$GITHUB_OUTPUT"
          elif [ "$FAILED" -gt 0 ]; then
            echo "status=‚ùå ${PASSED}/${TOTAL} passed (${FAILED} failed)" >> "$GITHUB_OUTPUT"
          else
            echo "status=‚úÖ ${PASSED}/${TOTAL} passed" >> "$GITHUB_OUTPUT"
          fi

      - name: Upload screenshot
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: emulator-screenshot
          path: screenshot.png
          retention-days: 14

      - name: Push screenshot to ci-screenshots branch
        if: always() && hashFiles('screenshot.png') != ''
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Create or update orphan branch
          git checkout --orphan ci-screenshots || git checkout ci-screenshots
          git rm -rf . 2>/dev/null || true
          cp ${{ github.workspace }}/screenshot.png screenshot.png 2>/dev/null || true

          # If screenshot exists, commit and push
          if [ -f screenshot.png ]; then
            git add screenshot.png
            git commit -m "Update screenshot from PR #${{ github.event.pull_request.number }} ($(date -u +%Y-%m-%dT%H:%M:%SZ))"
            git push origin ci-screenshots --force
          fi

      - name: Update PR comment with screenshot & UI test results
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const uiTestStatus = '${{ steps.ui-tests.outputs.status }}' || '‚ö†Ô∏è Unknown';
            const sha = context.sha.substring(0, 7);
            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            const artifactUrl = `${runUrl}/artifacts`;
            const screenshotUrl = `https://raw.githubusercontent.com/${context.repo.owner}/${context.repo.repo}/ci-screenshots/screenshot.png`;
            const timestamp = new Date().getTime();

            // Fetch build job info from the existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            const botComment = comments.find(c =>
              c.user.type === 'Bot' && c.body.includes('Generated by GitHub Actions')
            );

            // Preserve the existing build section and append emulator results
            let existingBody = botComment ? botComment.body : '';
            // Remove the "pending" line and the footer
            existingBody = existingBody.replace(/\n> ‚è≥ Emulator tests & screenshot pending‚Ä¶\n/, '\n');
            existingBody = existingBody.replace(/\n<sub>ü§ñ Generated by GitHub Actions<\/sub>/, '');

            let body = existingBody;
            body += `| **UI Tests** | ${uiTestStatus} |\n`;
            body += `\n### üì± App Screenshot\n\n`;
            body += `![App Screenshot](${screenshotUrl}?t=${timestamp})\n`;
            body += `\n<sub>ü§ñ Generated by GitHub Actions</sub>`;

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body,
              });
            }
